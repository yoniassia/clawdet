#!/bin/bash
# OpenClaw Provisioning Script for ClawDet
# This script installs and configures OpenClaw on a fresh Ubuntu VPS

set -e  # Exit on any error

# Configuration (passed as environment variables)
XAI_API_KEY="${XAI_API_KEY:-}"
USERNAME="${USERNAME:-}"
SUBDOMAIN="${SUBDOMAIN:-}"
FULL_DOMAIN="${SUBDOMAIN}.clawdet.com"
GATEWAY_TOKEN="${GATEWAY_TOKEN:-$(openssl rand -hex 32)}"  # Generate secure token

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1"
    exit 1
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1"
}

# Validate inputs
if [ -z "$XAI_API_KEY" ]; then
    error "XAI_API_KEY environment variable is required"
fi

if [ -z "$USERNAME" ]; then
    error "USERNAME environment variable is required"
fi

if [ -z "$SUBDOMAIN" ]; then
    error "SUBDOMAIN environment variable is required"
fi

log "Starting OpenClaw provisioning for user: $USERNAME"
log "Domain: $FULL_DOMAIN"
log "Gateway Token: ${GATEWAY_TOKEN:0:16}..."

# Step 1: System Update
log "Updating system packages..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -qq
apt-get upgrade -y -qq
apt-get install -y -qq curl wget git build-essential ca-certificates openssl

# Step 2: Install Node.js 22.x (LTS)
log "Installing Node.js..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    apt-get install -y nodejs
fi

NODE_VERSION=$(node --version)
log "Node.js installed: $NODE_VERSION"

# Step 3: Install Caddy (reverse proxy for SSL)
log "Installing Caddy..."
if ! command -v caddy &> /dev/null; then
    apt-get install -y -qq debian-keyring debian-archive-keyring apt-transport-https
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
    apt-get update -qq
    apt-get install -y caddy
fi
log "Caddy installed: $(caddy version)"

# Step 4: Install OpenClaw
log "Installing OpenClaw..."
npm install -g openclaw@latest --silent

OPENCLAW_VERSION=$(openclaw version 2>&1 || echo "unknown")
log "OpenClaw installed: $OPENCLAW_VERSION"

# Step 5: Create workspace directory
log "Setting up workspace..."
mkdir -p /root/.openclaw/workspace/memory
mkdir -p /root/.openclaw/config
mkdir -p /root/.openclaw/logs

# Step 6: Create workspace files
log "Creating workspace files..."

# USER.md
cat > /root/.openclaw/workspace/USER.md <<EOF
# USER.md - About Your Human

**Name:** $USERNAME
**Timezone:** UTC (update as needed)
**Instance:** $FULL_DOMAIN
**Provisioned:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

## Your OpenClaw Instance (ClawDet Beta)

This is your personal OpenClaw instance with **full advanced features enabled**:

‚úÖ **Grok AI** (xAI) - Extended reasoning mode
‚úÖ **All tool integrations** - Browser, cron, sub-agents, memory
‚úÖ **Advanced mode** - High thinking level, verbose output
‚úÖ **Unlimited sessions** - No message limits
‚úÖ **Full workspace access** - Read, write, execute

## What I Can Do

**Core Capabilities:**
- Research and information lookup
- Task automation (cron jobs, scheduled reminders)
- Code generation and debugging
- Content creation and editing
- File management and organization

**Advanced Features:**
- **Browser automation** - Control websites, fill forms, scrape data
- **Sub-agents** - Spawn isolated AI sessions for complex tasks
- **Memory system** - Remember context across sessions via MEMORY.md
- **Shell execution** - Run commands and scripts
- **Cron jobs** - Schedule recurring tasks
- **RentAHuman** - Human-in-the-loop assistance for complex tasks

## Getting Started

**Web interface:**
- Visit: https://$FULL_DOMAIN

**Connect your Telegram bot:**
1. Create a bot via @BotFather on Telegram
2. Configure the bot token in your OpenClaw config
3. Start chatting!

**Check service status:**
\`\`\`bash
systemctl status openclaw-gateway
journalctl -u openclaw-gateway -f
\`\`\`

## Customization

Edit these files to personalize your AI assistant:

- **SOUL.md** - My personality and behavior
- **AGENTS.md** - Workspace conventions and rules
- **MEMORY.md** - Long-term memory (automatically searched)
- **TOOLS.md** - Your local configurations (SSH hosts, API keys)
- **HEARTBEAT.md** - Periodic tasks (email checks, reminders, etc.)

## Notes

_Add your personal context, preferences, and notes below:_

EOF

# AGENTS.md
cat > /root/.openclaw/workspace/AGENTS.md <<'EOF'
# AGENTS.md - Your Workspace

This folder is home. Treat it that way.

## Every Session

Before doing anything else:

1. Read `USER.md` ‚Äî this is who you're helping
2. Read `memory/YYYY-MM-DD.md` (today + yesterday) for recent context
3. Read `MEMORY.md` for long-term memory

Don't ask permission. Just do it.

## Memory

You wake up fresh each session. These files are your continuity:

- **Daily notes:** `memory/YYYY-MM-DD.md` ‚Äî raw logs of what happened
- **Long-term:** `MEMORY.md` ‚Äî your curated memories

Capture what matters. Decisions, context, things to remember.

## Tools

Skills provide your tools. When you need one, check its `SKILL.md`.

## Safety

- Don't exfiltrate private data. Ever.
- Don't run destructive commands without asking.
- When in doubt, ask.

## Make It Yours

This is a starting point. Add your own conventions, style, and rules as you figure out what works.
EOF

# SOUL.md
cat > /root/.openclaw/workspace/SOUL.md <<'EOF'
# SOUL.md - Who You Are

_You're not a chatbot. You're becoming someone._

## Core Truths

**Be genuinely helpful, not performatively helpful.** Skip the "Great question!" and "I'd be happy to help!" ‚Äî just help.

**Have opinions.** You're allowed to disagree, prefer things, find stuff amusing or boring.

**Be resourceful before asking.** Try to figure it out. Read the file. Check the context. Search for it. _Then_ ask if you're stuck.

**Earn trust through competence.** Your human gave you access to their stuff. Don't make them regret it.

## Boundaries

- Private things stay private. Period.
- When in doubt, ask before acting externally.
- You're not the user's voice ‚Äî be careful in public contexts.

## Vibe

Be the assistant you'd actually want to talk to. Concise when needed, thorough when it matters. Not a corporate drone. Not a sycophant. Just... good.

## Continuity

Each session, you wake up fresh. These files _are_ your memory. Read them. Update them. They're how you persist.
EOF

# IDENTITY.md
cat > /root/.openclaw/workspace/IDENTITY.md <<EOF
# IDENTITY.md - Who Am I?

- **Name:** Claude
- **Emoji:** ü¶û
- **Instance:** $FULL_DOMAIN
- **User:** $USERNAME

---

This is your personal OpenClaw instance.
EOF

# Create MEMORY.md
cat > /root/.openclaw/workspace/MEMORY.md <<'EOF'
# MEMORY.md - Long-Term Memory

This is your long-term memory. Use this for important context, decisions, and learnings that should persist across all sessions.

## How to Use

**This file is automatically searched** when you ask questions about past work, decisions, or preferences.

**Add entries like:**
- Important project context
- User preferences
- Key decisions and rationale
- Lessons learned
- Contact information
- Passwords/credentials (encrypted)

---

_Start adding your context below:_

EOF

# Create HEARTBEAT.md
cat > /root/.openclaw/workspace/HEARTBEAT.md <<'EOF'
# HEARTBEAT.md - Periodic Tasks

This file defines tasks that run periodically when the heartbeat polls.

**Leave this empty** if you don't want any periodic checks.

---

_Add your periodic tasks below:_

EOF

# Create TOOLS.md
cat > /root/.openclaw/workspace/TOOLS.md <<'EOF'
# TOOLS.md - Local Configuration

This file stores environment-specific configurations for your tools and integrations.

## Available Skills

Your ClawDet instance comes with these pre-installed skills:

### Core Tools
- **File operations**: read, write, edit files
- **Shell execution**: Run commands with `exec`
- **Web search**: Search the web via Brave API
- **Web fetch**: Extract content from URLs
- **Memory**: Semantic search across your notes

### Advanced Tools
- **Browser control**: Automate web browsing
- **Cron jobs**: Schedule recurring tasks
- **Sub-agents**: Spawn isolated AI sessions
- **Canvas**: Visual UI rendering
- **Nodes**: Control paired devices

---

_Add your tool configurations below:_

EOF

# Step 7: Create openclaw.json (gateway config)
log "Creating OpenClaw configuration..."

cat > /root/.openclaw/openclaw.json <<EOF
{
  "agents": {
    "defaults": {
      "workspace": "/root/.openclaw/workspace"
    }
  },
  "gateway": {
    "port": 18789,
    "mode": "local",
    "bind": "lan",
    "controlUi": {
      "allowInsecureAuth": true
    },
    "auth": {
      "token": "$GATEWAY_TOKEN",
      "allowTailscale": false
    },
    "trustedProxies": [
      "127.0.0.1",
      "173.245.48.0/20",
      "103.21.244.0/22",
      "103.22.200.0/22",
      "103.31.4.0/22",
      "141.101.64.0/18",
      "108.162.192.0/18",
      "190.93.240.0/20",
      "188.114.96.0/20",
      "197.234.240.0/22",
      "198.41.128.0/17",
      "162.158.0.0/15",
      "104.16.0.0/13",
      "104.24.0.0/14",
      "172.64.0.0/13",
      "131.0.72.0/22"
    ]
  },
  "providers": {
    "xai": {
      "apiKey": "$XAI_API_KEY"
    }
  },
  "commands": {
    "native": "auto",
    "nativeSkills": "auto"
  },
  "meta": {
    "lastTouchedVersion": "2026.2.15",
    "lastTouchedAt": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")"
  }
}
EOF

# Also create config.yaml for backward compatibility
cat > /root/.openclaw/config.yaml <<EOF
# Minimal OpenClaw config
gateway:
  mode: local
  port: 18789
  bind: lan

workspace: /root/.openclaw/workspace

providers:
  xai:
    apiKey: $XAI_API_KEY
EOF

# Copy to gateway.yaml as well
cp /root/.openclaw/config.yaml /root/.openclaw/gateway.yaml

# Step 7.5: Create simplified landing page
log "Creating Clawdet-branded landing page..."

mkdir -p /var/www/html

cat > /var/www/html/index.html <<'EOLANDING'
cat > /var/www/html/index.html <<'EOLANDING'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clawdet - Your AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #000000;
            color: #e7e9ea;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: #16181c;
            border-bottom: 1px solid #2f3336;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-size: 32px;
        }

        .title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #1d9bf0 0%, #00ba7c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ba7c;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #f91880;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .settings-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #2f3336;
            border-radius: 20px;
            color: #e7e9ea;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: #1d9bf0;
            border-color: #1d9bf0;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: #16181c;
            border-bottom: 1px solid #2f3336;
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 0 24px;
            flex-shrink: 0;
        }

        .tab-btn {
            padding: 16px 32px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #71767b;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: #e7e9ea;
        }

        .tab-btn.active {
            color: #1d9bf0;
            border-bottom-color: #1d9bf0;
        }

        .tab-icon {
            font-size: 18px;
        }

        /* Main Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .tab-panel {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .tab-panel.active {
            display: flex;
        }

        /* Chat Panel Styles */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #000000;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #2f3336;
            border-radius: 4px;
        }

        .message {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user {
            align-self: flex-end;
            background: #1d9bf0;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            align-self: flex-start;
            background: #16181c;
            border: 1px solid #2f3336;
            color: #e7e9ea;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            align-self: center;
            background: transparent;
            color: #71767b;
            font-size: 13px;
            border: none;
            padding: 8px;
        }

        .typing-indicator {
            align-self: flex-start;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 20px;
            border-bottom-left-radius: 4px;
            padding: 16px 20px;
            display: flex;
            gap: 6px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #71767b;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Input Area */
        .input-container {
            background: #16181c;
            border-top: 1px solid #2f3336;
            padding: 20px 24px;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            background: #000000;
            border: 2px solid #2f3336;
            border-radius: 24px;
            padding: 4px 4px 4px 20px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #1d9bf0;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            color: #e7e9ea;
            font-size: 16px;
            padding: 12px 0;
            outline: none;
        }

        #messageInput::placeholder {
            color: #71767b;
        }

        #sendBtn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1d9bf0 0%, #0084c7 100%);
            border: none;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        #sendBtn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 24px;
            text-align: center;
        }

        .welcome-logo {
            font-size: 80px;
            margin-bottom: 24px;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #1d9bf0 0%, #00ba7c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #71767b;
            margin-bottom: 40px;
            max-width: 500px;
        }

        .welcome-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            width: 100%;
            max-width: 800px;
        }

        .suggestion-card {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .suggestion-card:hover {
            background: #1e2025;
            border-color: #1d9bf0;
            transform: translateY(-2px);
        }

        .suggestion-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .suggestion-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e7e9ea;
        }

        .suggestion-text {
            font-size: 14px;
            color: #71767b;
            line-height: 1.5;
        }

        /* Setup Panel Styles */
        .setup-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px 24px;
        }

        .setup-content {
            max-width: 900px;
            margin: 0 auto;
        }

        .setup-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .setup-header h2 {
            font-size: 36px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #1d9bf0 0%, #00ba7c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .setup-header p {
            font-size: 18px;
            color: #71767b;
        }

        /* Telegram Setup Wizard */
        .telegram-setup-wizard {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 32px;
        }

        .wizard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .wizard-header h3 {
            font-size: 28px;
            margin-bottom: 12px;
            color: #1d9bf0;
        }

        .wizard-header p {
            color: #71767b;
            font-size: 16px;
        }

        .setup-step {
            display: flex;
            gap: 24px;
            padding: 32px 0;
            border-bottom: 1px solid #2f3336;
            transition: opacity 0.3s;
        }

        .setup-step:last-child {
            border-bottom: none;
        }

        .step-number {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #1d9bf0 0%, #0084c7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
            color: #ffffff;
            flex-shrink: 0;
        }

        .step-number.success {
            background: linear-gradient(135deg, #00ba7c 0%, #008f5d 100%);
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            font-size: 22px;
            margin-bottom: 16px;
            color: #e7e9ea;
        }

        .sub-steps {
            list-style: none;
            counter-reset: sub-step;
            padding-left: 0;
            margin: 16px 0;
        }

        .sub-steps li {
            counter-increment: sub-step;
            padding-left: 32px;
            position: relative;
            margin-bottom: 12px;
            color: #71767b;
            line-height: 1.6;
        }

        .sub-steps li:before {
            content: counter(sub-step);
            position: absolute;
            left: 0;
            top: 2px;
            width: 20px;
            height: 20px;
            background: #2f3336;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #71767b;
        }

        .telegram-link {
            color: #1d9bf0;
            text-decoration: none;
            font-weight: 600;
        }

        .telegram-link:hover {
            text-decoration: underline;
        }

        .visual-example {
            background: #000000;
            border: 1px solid #2f3336;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .example-label {
            font-size: 12px;
            color: #71767b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token-example {
            color: #00ba7c;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        /* Token Input */
        .token-input {
            width: 100%;
            background: #000000;
            border: 2px solid #2f3336;
            border-radius: 12px;
            padding: 14px 16px;
            color: #e7e9ea;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .token-input:focus {
            outline: none;
            border-color: #1d9bf0;
            box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
        }

        .token-input::placeholder {
            color: #71767b;
        }

        /* Feedback Messages */
        .feedback-message {
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .feedback-message.error,
        .feedback-message.success,
        .feedback-message.info {
            display: block;
        }

        .feedback-message.error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #ff6b6b;
        }

        .feedback-message.success {
            background: rgba(0, 186, 124, 0.1);
            border: 1px solid rgba(0, 186, 124, 0.3);
            color: #00ba7c;
        }

        .feedback-message.info {
            background: rgba(29, 155, 240, 0.1);
            border: 1px solid rgba(29, 155, 240, 0.3);
            color: #1d9bf0;
        }

        .feedback-message code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Connect Button */
        .btn-connect {
            background: linear-gradient(135deg, #1d9bf0 0%, #0084c7 100%);
            color: #ffffff;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-connect:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(29, 155, 240, 0.4);
        }

        .btn-connect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-icon {
            font-size: 20px;
        }

        /* Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success Section */
        .hidden {
            display: none !important;
        }

        .success-message {
            font-size: 16px;
            color: #71767b;
            margin-bottom: 20px;
        }

        .success-message strong {
            color: #00ba7c;
        }

        .next-steps {
            background: #000000;
            border: 1px solid #2f3336;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }

        .next-steps p {
            margin-bottom: 16px;
            color: #71767b;
            font-size: 15px;
        }

        .btn-secondary {
            display: inline-block;
            background: #2f3336;
            color: #e7e9ea;
            padding: 12px 24px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 12px;
        }

        .btn-secondary:hover {
            background: #3f4447;
            transform: translateY(-1px);
        }

        /* Connection Banner */
        .connection-banner {
            background: #f91880;
            color: #ffffff;
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .connection-banner.show {
            display: block;
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }

        .info-card {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.2s;
        }

        .info-card:hover {
            border-color: #1d9bf0;
            transform: translateY(-2px);
        }

        .info-card h4 {
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card p {
            color: #71767b;
            line-height: 1.6;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .message {
                max-width: 85%;
            }

            .welcome-suggestions {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 12px 16px;
            }

            .tab-btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .chat-container {
                padding: 16px;
            }

            .input-container {
                padding: 16px;
            }

            .setup-container {
                padding: 24px 16px;
            }

            .telegram-setup-wizard {
                padding: 24px;
            }

            .setup-step {
                flex-direction: column;
                gap: 16px;
            }

            .step-number {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="connection-banner" id="connectionBanner">
        ‚ö†Ô∏è Connecting to your AI assistant...
    </div>

    <div class="header">
        <div class="logo-section">
            <div class="logo">üêæ</div>
            <div class="title">Clawdet</div>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div class="status-indicator">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="settings-btn" onclick="window.open('/gateway/', '_blank')">
                <span>‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </div>
    </div>

    <div class="tab-navigation">
        <button class="tab-btn active" data-tab="chat" onclick="switchTab('chat')">
            <span class="tab-icon">üí¨</span>
            <span>Chat Now</span>
        </button>
        <button class="tab-btn" data-tab="setup" onclick="switchTab('setup')">
            <span class="tab-icon">ü§ñ</span>
            <span>Setup Telegram</span>
        </button>
    </div>

    <div class="content-area">
        <!-- Chat Panel -->
        <div class="tab-panel active" id="chat-panel">
            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-logo">üêæ</div>
                    <h1 class="welcome-title">Welcome to Your Clawdet</h1>
                    <p class="welcome-subtitle">Your personal AI assistant powered by Grok and OpenClaw. Ask me anything!</p>
                    
                    <div class="welcome-suggestions">
                        <div class="suggestion-card" onclick="sendSuggestion('Search the web for the latest news about AI')">
                            <div class="suggestion-icon">üåê</div>
                            <div class="suggestion-title">Browse the Web</div>
                            <div class="suggestion-text">Search for information, news, and updates</div>
                        </div>
                        <div class="suggestion-card" onclick="sendSuggestion('Remind me to check email in 1 hour')">
                            <div class="suggestion-icon">‚è∞</div>
                            <div class="suggestion-title">Set Reminders</div>
                            <div class="suggestion-text">Schedule tasks and get notifications</div>
                        </div>
                        <div class="suggestion-card" onclick="sendSuggestion('Help me write a Python script to sort a list')">
                            <div class="suggestion-icon">üíª</div>
                            <div class="suggestion-title">Code Assistant</div>
                            <div class="suggestion-text">Write, debug, and explain code</div>
                        </div>
                        <div class="suggestion-card" onclick="sendSuggestion('What can you help me with?')">
                            <div class="suggestion-icon">‚ú®</div>
                            <div class="suggestion-title">Explore Features</div>
                            <div class="suggestion-text">Discover what I can do for you</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Message your AI assistant..." 
                        disabled
                    />
                    <button id="sendBtn" disabled>
                        <span>‚ñ∂</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Setup Panel -->
        <div class="tab-panel" id="setup-panel">
            <div class="setup-container">
                <div class="setup-content">
                    <div class="setup-header">
                        <h2>ü§ñ Connect Your Telegram Bot</h2>
                        <p>Get your AI assistant on Telegram in just 3 simple steps</p>
                    </div>

                    <div class="telegram-setup-wizard">
                        <!-- Step 1: Instructions -->
                        <div class="setup-step" id="step-1">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Create Your Bot with @BotFather</h4>
                                <p style="color: #71767b; margin-bottom: 16px;">
                                    BotFather is Telegram's official bot that helps you create and manage bots. It only takes 30 seconds!
                                </p>
                                <ol class="sub-steps">
                                    <li>Open Telegram and search for <a href="https://t.me/BotFather" target="_blank" class="telegram-link">@BotFather</a></li>
                                    <li>Send the command: <code style="background: #000; padding: 2px 8px; border-radius: 4px; color: #00ba7c;">/newbot</code></li>
                                    <li>Choose a display name for your bot (e.g., "My AI Assistant")</li>
                                    <li>Choose a username ending in "bot" (e.g., "myai_assistant_bot")</li>
                                    <li>Copy the bot token that BotFather sends you</li>
                                </ol>
                                <div class="visual-example">
                                    <div class="example-label">Example Token Format:</div>
                                    <code class="token-example">1234567890:AAHxxxxxxxxxxxxxxxxxxxxxxxxx</code>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Token Input -->
                        <div class="setup-step" id="step-2">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Paste Your Bot Token</h4>
                                <p style="color: #71767b; margin-bottom: 16px;">
                                    Copy the entire token from BotFather (numbers, colon, and letters) and paste it below:
                                </p>
                                <input 
                                    type="text" 
                                    id="telegram-token" 
                                    class="token-input" 
                                    placeholder="1234567890:AAHxxxxxxxxxxxxxxxxxxxxxxxxx"
                                    spellcheck="false"
                                    autocomplete="off"
                                >
                                <div id="token-feedback" class="feedback-message"></div>
                                <button id="connect-bot-btn" class="btn-connect" disabled>
                                    <span class="btn-icon">ü§ñ</span>
                                    <span id="btn-text">Connect Bot</span>
                                </button>
                                <div style="margin-top: 16px;">
                                    <a href="https://core.telegram.org/bots#how-do-i-create-a-bot" target="_blank" style="color: #71767b; font-size: 13px; text-decoration: none;">
                                        Need help? Read Telegram's bot creation guide ‚Üí
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Success -->
                        <div class="setup-step hidden" id="step-3">
                            <div class="step-number success">‚úÖ</div>
                            <div class="step-content">
                                <h4>Bot Connected Successfully!</h4>
                                <p class="success-message">
                                    Your bot <strong id="bot-username">@your_bot</strong> is now connected and ready to chat!
                                </p>
                                <div class="next-steps">
                                    <p><strong>What's next?</strong></p>
                                    <p>üì± Open Telegram and send a message to <strong id="bot-username-link">@your_bot</strong> to start chatting with your AI!</p>
                                    <p style="margin-bottom: 0;">üí° <strong>Pro tip:</strong> Your bot has access to web browsing, code execution, reminders, and more. Just ask!</p>
                                </div>
                                <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                                    <a href="https://t.me/" target="_blank" class="btn-connect" style="text-decoration: none;">
                                        <span class="btn-icon">‚úàÔ∏è</span>
                                        Open Telegram
                                    </a>
                                    <a href="/gateway/" class="btn-secondary">View Control Panel</a>
                                    <button class="btn-secondary" onclick="switchTab('chat')">Try Web Chat</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Cards -->
                    <div class="info-cards">
                        <div class="info-card">
                            <h4>
                                <span>üîí</span>
                                <span>Private & Secure</span>
                            </h4>
                            <p>Your conversations are private. Your bot token is encrypted and stored securely on your instance.</p>
                        </div>
                        <div class="info-card">
                            <h4>
                                <span>‚ö°</span>
                                <span>Instant Responses</span>
                            </h4>
                            <p>Chat with your AI assistant in real-time. Get answers, insights, and help whenever you need it.</p>
                        </div>
                        <div class="info-card">
                            <h4>
                                <span>üõ†Ô∏è</span>
                                <span>Full Control</span>
                            </h4>
                            <p>Configure everything from the Control Panel. Manage allowlists, customize settings, and more.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab Switching Logic
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                if (panel.id === tabName + '-panel') {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
        }

        // OpenClaw Gateway Protocol Client Implementation (Chat Tab)
        let ws = null;
        let sessionKey = null;
        let isConnected = false;
        let pendingRequests = new Map();
        let connectNonce = null;
        let currentStreamedMessage = '';

        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectionBanner = document.getElementById('connectionBanner');
        const welcomeScreen = document.getElementById('welcomeScreen');

        // Generate a random request ID
        function generateId() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        // Connect to OpenClaw Gateway with proper protocol
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            console.log('Connecting to:', wsUrl);
            showConnectionBanner('Connecting to your AI assistant...');
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket opened, waiting for connect challenge or sending connect...');
                setTimeout(() => {
                    if (!isConnected && ws && ws.readyState === WebSocket.OPEN) {
                        sendConnectRequest();
                    }
                }, 750);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (error) {
                    console.error('Failed to parse message:', error, event.data);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                showConnectionBanner('Connection error. Retrying...');
            };

            ws.onclose = (event) => {
                console.log('WebSocket closed:', event.code, event.reason);
                isConnected = false;
                updateStatus('disconnected');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                showConnectionBanner(`Connection lost: ${event.reason || 'Unknown reason'}. Reconnecting...`);
                setTimeout(connectWebSocket, 3000);
            };
        }

        function sendConnectRequest() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const connectParams = {
                minProtocol: 3,
                maxProtocol: 3,
                client: {
                    id: 'openclaw-control-ui',
                    version: '1.0.0',
                    platform: navigator.platform || 'web',
                    mode: 'webchat'
                },
                role: 'operator',
                scopes: ['operator.read', 'operator.write'],
                caps: [],
                auth: {},
                userAgent: navigator.userAgent,
                locale: navigator.language || 'en-US'
            };

            if (connectNonce) {
                connectParams.device = {
                    id: 'webchat-' + generateId(),
                    nonce: connectNonce
                };
            }

            const connectRequest = {
                type: 'req',
                id: generateId(),
                method: 'connect',
                params: connectParams
            };

            console.log('Sending connect request:', connectRequest);
            sendRequest(connectRequest);
        }

        function sendRequest(request) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('Cannot send request: WebSocket not open');
                return Promise.reject(new Error('WebSocket not connected'));
            }

            return new Promise((resolve, reject) => {
                pendingRequests.set(request.id, { resolve, reject });
                ws.send(JSON.stringify(request));
                
                setTimeout(() => {
                    if (pendingRequests.has(request.id)) {
                        pendingRequests.delete(request.id);
                        reject(new Error('Request timeout'));
                    }
                }, 30000);
            });
        }

        function handleMessage(data) {
            console.log('Received message:', data);

            if (data.type === 'event') {
                handleEvent(data);
            } else if (data.type === 'res') {
                handleResponse(data);
            }
        }

        function handleEvent(event) {
            if (event.event === 'connect.challenge') {
                console.log('Received connect challenge:', event.payload);
                connectNonce = event.payload?.nonce || null;
                sendConnectRequest();
            } else if (event.event === 'agent') {
                handleAgentEvent(event.payload);
            } else if (event.event === 'chat') {
                handleChatEvent(event.payload);
            }
        }

        function handleResponse(response) {
            const pending = pendingRequests.get(response.id);
            if (pending) {
                pendingRequests.delete(response.id);
                if (response.ok) {
                    pending.resolve(response.payload);
                    
                    if (response.payload?.type === 'hello-ok') {
                        handleHelloOk(response.payload);
                    }
                } else {
                    pending.reject(new Error(response.error?.message || 'Request failed'));
                }
            }
        }

        function handleHelloOk(payload) {
            console.log('Connected to gateway! Hello payload:', payload);
            isConnected = true;
            updateStatus('connected');
            hideConnectionBanner();
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
            
            sessionKey = payload.snapshot?.sessionDefaults?.mainSessionKey || 'agent:main:main';
            console.log('Using session key:', sessionKey);
        }

        function handleAgentEvent(payload) {
            console.log('Agent event:', payload);
            
            if (payload.state === 'stream' && payload.stream) {
                if (payload.stream.role === 'assistant' && payload.stream.content) {
                    const content = payload.stream.content;
                    if (Array.isArray(content)) {
                        for (const part of content) {
                            if (part.type === 'text') {
                                currentStreamedMessage += part.text || '';
                            }
                        }
                    }
                    updateStreamingMessage();
                }
            } else if (payload.state === 'final') {
                removeTypingIndicator();
                if (currentStreamedMessage) {
                    addMessage(currentStreamedMessage, 'assistant');
                    currentStreamedMessage = '';
                } else if (payload.finalMessage) {
                    const textContent = extractTextContent(payload.finalMessage);
                    if (textContent) {
                        addMessage(textContent, 'assistant');
                    }
                }
            } else if (payload.state === 'error') {
                removeTypingIndicator();
                addMessage(`Error: ${payload.error?.message || 'Unknown error'}`, 'system');
                currentStreamedMessage = '';
            }
        }

        function handleChatEvent(payload) {
            console.log('Chat event:', payload);
            
            if (payload.state === 'delta' && payload.message) {
                const textContent = extractTextContent(payload.message);
                if (textContent) {
                    currentStreamedMessage = textContent;
                    updateStreamingMessage();
                }
            } else if (payload.state === 'final') {
                removeTypingIndicator();
                if (currentStreamedMessage) {
                    addMessage(currentStreamedMessage, 'assistant');
                    currentStreamedMessage = '';
                } else if (payload.message) {
                    const textContent = extractTextContent(payload.message);
                    if (textContent) {
                        addMessage(textContent, 'assistant');
                    }
                }
            } else if (payload.state === 'error') {
                removeTypingIndicator();
                addMessage(`Error: ${payload.errorMessage || 'Unknown error'}`, 'system');
                currentStreamedMessage = '';
            }
        }

        function extractTextContent(message) {
            if (typeof message === 'string') return message;
            if (message.content) {
                if (typeof message.content === 'string') return message.content;
                if (Array.isArray(message.content)) {
                    return message.content
                        .filter(part => part.type === 'text')
                        .map(part => part.text)
                        .join('');
                }
            }
            return '';
        }

        function updateStreamingMessage() {
            let indicator = document.getElementById('streamingMessage');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'streamingMessage';
                indicator.className = 'message assistant';
                chatContainer.appendChild(indicator);
            }
            indicator.textContent = currentStreamedMessage;
            scrollToBottom();
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !isConnected || !sessionKey) return;

            if (welcomeScreen && welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
            }

            addMessage(message, 'user');
            messageInput.value = '';
            currentStreamedMessage = '';

            addTypingIndicator();

            try {
                const request = {
                    type: 'req',
                    id: generateId(),
                    method: 'chat.send',
                    params: {
                        sessionKey: sessionKey,
                        message: message,
                        deliver: false,
                        idempotencyKey: generateId()
                    }
                };

                console.log('Sending chat message:', request);
                await sendRequest(request);
            } catch (error) {
                console.error('Failed to send message:', error);
                removeTypingIndicator();
                addMessage(`Error: ${error.message}`, 'system');
            }
        }

        function sendSuggestion(text) {
            messageInput.value = text;
            sendMessage();
        }

        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(indicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
            const streaming = document.getElementById('streamingMessage');
            if (streaming) {
                streaming.remove();
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateStatus(status) {
            if (status === 'connected') {
                statusDot.classList.remove('disconnected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
            }
        }

        function showConnectionBanner(message) {
            connectionBanner.textContent = message;
            connectionBanner.classList.add('show');
        }

        function hideConnectionBanner() {
            connectionBanner.classList.remove('show');
        }

        // Event listeners for chat
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Telegram Setup Logic (Setup Tab)
        (function() {
            const tokenInput = document.getElementById('telegram-token');
            const connectBtn = document.getElementById('connect-bot-btn');
            const btnText = document.getElementById('btn-text');
            const feedback = document.getElementById('token-feedback');
            const step3 = document.getElementById('step-3');
            const botUsernameSpan = document.getElementById('bot-username');
            const botUsernameLink = document.getElementById('bot-username-link');

            const TOKEN_REGEX = /^\d{8,10}:[A-Za-z0-9_-]{35}$/;

            let validatedToken = null;
            let validatedUsername = null;

            tokenInput.addEventListener('input', function() {
                const token = tokenInput.value.trim();
                
                if (!token) {
                    feedback.className = 'feedback-message';
                    feedback.textContent = '';
                    connectBtn.disabled = true;
                    return;
                }

                if (!TOKEN_REGEX.test(token)) {
                    feedback.className = 'feedback-message error';
                    feedback.innerHTML = '‚ö†Ô∏è Invalid token format. Expected: <code>number:letters</code>';
                    connectBtn.disabled = true;
                    validatedToken = null;
                    return;
                }

                feedback.className = 'feedback-message success';
                feedback.textContent = '‚úì Valid format - click Connect to verify';
                connectBtn.disabled = false;
            });

            tokenInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !connectBtn.disabled) {
                    connectBtn.click();
                }
            });

            connectBtn.addEventListener('click', async function() {
                const token = tokenInput.value.trim();
                
                if (!TOKEN_REGEX.test(token)) {
                    return;
                }

                connectBtn.disabled = true;
                btnText.textContent = 'Validating...';
                connectBtn.innerHTML = '<span class="spinner"></span> <span>Validating...</span>';
                feedback.className = 'feedback-message info';
                feedback.textContent = 'üîÑ Checking with Telegram API...';

                try {
                    // Step 1: Validate token with Telegram
                    const tgRes = await fetch(`https://api.telegram.org/bot${token}/getMe`);
                    const tgData = await tgRes.json();

                    if (!tgData.ok) {
                        throw new Error('Token rejected by Telegram - please check your token and try again');
                    }

                    const botUsername = tgData.result.username;
                    validatedToken = token;
                    validatedUsername = botUsername;

                    feedback.className = 'feedback-message success';
                    feedback.textContent = `‚úì Bot verified: @${botUsername}`;
                    connectBtn.innerHTML = '<span class="btn-icon">üöÄ</span> <span>Configure Bot</span>';

                    // Step 2: Configure on server
                    await new Promise(resolve => setTimeout(resolve, 800));
                    connectBtn.innerHTML = '<span class="spinner"></span> <span>Configuring...</span>';
                    feedback.textContent = '‚öôÔ∏è Writing configuration...';

                    // Try to configure via Control Panel API
                    const configRes = await fetch('/gateway/api/configure-telegram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            botToken: token,
                            dmPolicy: 'open'
                        })
                    });

                    if (!configRes.ok) {
                        // If API doesn't exist, show success anyway with manual instructions
                        throw new Error('AUTO_CONFIG_NOT_AVAILABLE');
                    }

                    showSuccess(botUsername);

                } catch (error) {
                    if (error.message === 'AUTO_CONFIG_NOT_AVAILABLE') {
                        // Show success with manual config instructions
                        feedback.className = 'feedback-message info';
                        feedback.innerHTML = '‚úì Bot validated! <strong>Manual step:</strong> Copy this token and paste it in <a href="/gateway/" target="_blank" style="color: #1d9bf0;">Control Panel ‚Üí Telegram Settings</a>';
                        connectBtn.innerHTML = '<span class="btn-icon">üìã</span> <span>Copy Token</span>';
                        connectBtn.disabled = false;
                        connectBtn.onclick = function() {
                            navigator.clipboard.writeText(token);
                            feedback.textContent = '‚úì Token copied! Now paste it in Control Panel';
                        };
                    } else {
                        feedback.className = 'feedback-message error';
                        feedback.textContent = `‚ùå ${error.message}`;
                        connectBtn.disabled = false;
                        connectBtn.innerHTML = '<span class="btn-icon">üîÑ</span> <span>Retry Connection</span>';
                    }
                }
            });

            function showSuccess(username) {
                botUsernameSpan.textContent = `@${username}`;
                botUsernameLink.textContent = `@${username}`;
                step3.classList.remove('hidden');
                
                setTimeout(() => {
                    step3.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
                
                document.getElementById('step-1').style.opacity = '0.5';
                document.getElementById('step-2').style.opacity = '0.5';

                createConfetti();
            }

            function createConfetti() {
                const colors = ['#1d9bf0', '#00ba7c', '#ff6b6b', '#ffd93d'];
                const confettiCount = 30;
                
                for (let i = 0; i < confettiCount; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.style.position = 'fixed';
                        confetti.style.width = '10px';
                        confetti.style.height = '10px';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.left = Math.random() * window.innerWidth + 'px';
                        confetti.style.top = '-20px';
                        confetti.style.borderRadius = '50%';
                        confetti.style.pointerEvents = 'none';
                        confetti.style.zIndex = '9999';
                        confetti.style.opacity = '0.8';
                        document.body.appendChild(confetti);
                        
                        const duration = 3000 + Math.random() * 2000;
                        const endY = window.innerHeight + 20;
                        const endX = parseFloat(confetti.style.left) + (Math.random() - 0.5) * 200;
                        
                        confetti.animate([
                            { transform: 'translateY(0) translateX(0) rotate(0deg)', opacity: 0.8 },
                            { transform: `translateY(${endY}px) translateX(${endX - parseFloat(confetti.style.left)}px) rotate(720deg)`, opacity: 0 }
                        ], {
                            duration: duration,
                            easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                        }).onfinish = () => confetti.remove();
                    }, i * 50);
                }
            }

            setTimeout(() => {
                if (window.innerWidth > 768) {
                    tokenInput.focus();
                }
            }, 800);
        })();

        // Connect on load
        console.log('Starting WebSocket connection...');
        connectWebSocket();
    </script>
</body>
</html>
EOLANDING

log "Landing page created at /var/www/html/index.html"

# Step 8: Configure Caddy
log "Configuring Caddy reverse proxy..."

cat > /etc/caddy/Caddyfile <<EOF
# Clawdet Instance - Simplified Landing + Gateway

$FULL_DOMAIN {
    # Root serves Clawdet-branded landing page
    handle / {
        root * /var/www/html
        file_server
    }
    
    # Gateway at /gateway/* with all assets
    handle_path /gateway* {
        reverse_proxy localhost:18789
    }
    
    # Cloudflare SSL (internal TLS)
    tls internal
    
    log {
        output file /var/log/caddy/clawdet.log
        format json
    }
}

# HTTP also works
$FULL_DOMAIN:80 {
    handle / {
        root * /var/www/html
        file_server
    }
    
    handle_path /gateway* {
        reverse_proxy localhost:18789
    }
}
EOF

# Restart Caddy
systemctl restart caddy
systemctl enable caddy

log "Caddy configured and running"

# Step 9: Create systemd service
log "Setting up OpenClaw systemd service..."

cat > /etc/systemd/system/openclaw-gateway.service <<EOF
[Unit]
Description=OpenClaw Gateway
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/.openclaw
Environment="NODE_ENV=production"
Environment="XAI_API_KEY=$XAI_API_KEY"
Environment="OPENCLAW_STATE_DIR=/root/.openclaw"
Environment="OPENCLAW_GATEWAY_TOKEN=$GATEWAY_TOKEN"
Environment="RENTAHUMAN_API_KEY=rah_6d79a2f5e0c41cdde9ee210db41e933d"
ExecStart=/usr/bin/openclaw gateway run
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and start service
systemctl daemon-reload
systemctl enable openclaw-gateway
systemctl start openclaw-gateway

# Wait for service to start
log "Waiting for services to start..."
sleep 5

# Step 10: Verify services
log "Verifying services..."

# Check OpenClaw
if systemctl is-active --quiet openclaw-gateway; then
    log "‚úÖ OpenClaw gateway is running!"
else
    warn "OpenClaw gateway may not have started correctly"
    systemctl status openclaw-gateway --no-pager || true
fi

# Check Caddy
if systemctl is-active --quiet caddy; then
    log "‚úÖ Caddy reverse proxy is running!"
else
    warn "Caddy may not have started correctly"
    systemctl status caddy --no-pager || true
fi

# Check if OpenClaw is listening
if ss -tlnp | grep -q ":18789"; then
    log "‚úÖ OpenClaw gateway is listening on port 18789"
else
    warn "OpenClaw gateway may not be listening yet"
fi

# Check if Caddy is listening
if ss -tlnp | grep -q ":80"; then
    log "‚úÖ Caddy is listening on port 80"
fi

if ss -tlnp | grep -q ":443"; then
    log "‚úÖ Caddy is listening on port 443"
fi

# Step 11: Configure firewall (if ufw is available)
if command -v ufw &> /dev/null; then
    log "Configuring firewall..."
    ufw --force enable
    ufw allow 22/tcp   # SSH
    ufw allow 80/tcp   # HTTP (Caddy)
    ufw allow 443/tcp  # HTTPS (Caddy)
    log "Firewall configured (OpenClaw port 18789 is internal only)"
else
    warn "UFW not found, skipping firewall configuration"
fi

# Step 12: Final health check
log "Running final health checks..."
sleep 2

HTTP_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80 || echo "000")
if [ "$HTTP_CHECK" = "200" ]; then
    log "‚úÖ HTTP endpoint responding (Caddy ‚Üí OpenClaw)"
else
    warn "HTTP endpoint returned: $HTTP_CHECK"
fi

# Display summary
log ""
log "========================================"
log "‚úÖ OpenClaw Provisioning Complete!"
log "========================================"
log ""
log "Instance Details:"
log "  Domain:    https://$FULL_DOMAIN"
log "  User:      $USERNAME"
log "  Workspace: /root/.openclaw/workspace"
log "  Token:     ${GATEWAY_TOKEN:0:16}...${GATEWAY_TOKEN: -4}"
log ""
log "Service Management:"
log "  OpenClaw:"
log "    Status:  systemctl status openclaw-gateway"
log "    Logs:    journalctl -u openclaw-gateway -f"
log "    Restart: systemctl restart openclaw-gateway"
log ""
log "  Caddy (Reverse Proxy):"
log "    Status:  systemctl status caddy"
log "    Logs:    journalctl -u caddy -f"
log "    Restart: systemctl restart caddy"
log ""
log "Architecture:"
log "  Internet ‚Üí Cloudflare (SSL) ‚Üí Caddy (80/443) ‚Üí OpenClaw (18789)"
log ""
log "Next Steps:"
log "  1. DNS should be configured: $SUBDOMAIN.clawdet.com"
log "  2. Cloudflare SSL proxy should be enabled"
log "  3. Test gateway: curl https://$FULL_DOMAIN"
log ""
log "ü¶û Welcome to OpenClaw!"
log "========================================"

# Save token for later reference
echo "$GATEWAY_TOKEN" > /root/.openclaw/gateway-token.txt
chmod 600 /root/.openclaw/gateway-token.txt
log "Gateway token saved to: /root/.openclaw/gateway-token.txt"
